version: '3'

vars:
  APK: app/build/outputs/apk/debug/app-debug.apk
  AVD: Pixel_7_API_35
  PKG: com.kafka.launcher.debug

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # WSL/Linux tasks
  fmt:
    desc: Format code
    cmds:
      - uv run ruff check . --fix
      - uv run ruff format .

  test:
    desc: Run unit tests
    cmds:
      - ./gradlew testDebugUnitTest

  lint:
    desc: Run lint checks
    cmds:
      - ./gradlew lint

  build:
    desc: Build debug APK
    cmds:
      - ./gradlew assembleDebug

  clean:
    desc: Clean build artifacts
    cmds:
      - ./gradlew clean

  full:
    desc: Format, lint, test, and build
    cmds:
      - task: fmt
      - task: lint
      - task: test
      - task: build

  commit:
    desc: Commit with message (use -- MESSAGE="msg")
    cmds:
      - git add .
      - git commit -m "{{.MESSAGE}}"

  push:
    desc: Full build, commit, and push
    cmds:
      - task: full
      - task: commit
        vars: {MESSAGE: "{{.MESSAGE}}"}
      - git push

  # Windows: ONE COMMAND ONLY
  win:
    desc: Complete automated test (Windows - ONE COMMAND)
    cmds:
      - powershell -c "Write-Host 'Syncing latest code from WSL...'"
      - powershell -c "Copy-Item -Force Z:\\home\\kafka\\projects\\launcher\\Taskfile.yml C:\\Users\\$env:USERNAME\\projects\\launcher\\Taskfile.yml"
      - powershell -c "Copy-Item -Force -Recurse Z:\\home\\kafka\\projects\\launcher\\app C:\\Users\\$env:USERNAME\\projects\\launcher\\app"
      - powershell -c ".\\gradlew.bat assembleDebug"
      - powershell -c "Write-Host 'Restarting adb server...'"
      - powershell -c "adb kill-server; adb start-server; adb wait-for-device"
      - powershell -c "Write-Host 'Installing APK...'"
      - powershell -c "adb install -r {{.APK}}"
      - powershell -c "Write-Host 'Launching app...'"
      - powershell -c "adb shell am start -n {{.PKG}}/com.kafka.launcher.MainActivity"
      - powershell -c "Write-Host 'Capturing logs for 10 seconds...'"
      - powershell -c "adb logcat -c"
      - powershell -c "Start-Job -ScriptBlock { adb logcat } | Wait-Job -Timeout 10 | Receive-Job > crash.log"
      - powershell -c "Write-Host 'Log saved to crash.log'"
      - powershell -c "if (Select-String -Path crash.log -Pattern 'FATAL|AndroidRuntime') { Write-Host 'CRASH DETECTED! Check crash.log' -ForegroundColor Red } else { Write-Host 'No crash detected' -ForegroundColor Green }"