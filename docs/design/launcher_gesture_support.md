# 仕様記録（Launcher のジェスチャー対応）

## 1. 目的

* サードパーティ Launcher における**基本ジェスチャー（ホーム、戻る、最近のアプリ）**のサポート可否を**機種/OEM/OS 別に明文化**し、製品仕様・対応方針・テスト手順を固定化する。

## 2. 結論（プロダクト方針）

* **Xiaomi（MIUI/HyperOS）**

  * サードパーティ Launcher を既定 HOME に設定すると、**システムのフルスクリーンジェスチャーが無効化され、3ボタンナビへ強制**される挙動が再現される。
  * **公式手段による有効化は不可**であり、**開発は凍結**する。Xiaomi 向けは**3ボタン前提 UI に自動フォールバック**する。
* **AOSP 系（例：Pixel / 一部 Samsung 等）**

  * **原則ジェスチャー利用は可能**。ただし Quickstep（Recents provider）特権との結合に起因し、**アニメーション連携などで完全一致しない場合がある**。
  * 出荷対象としては**ジェスチャー前提 UX を許容**するが、OS 更新ごとの回帰テストを運用に組み込む。

## 3. 背景（議論時系列・履歴要約）

* 問題提起：Xiaomi 端末でサードパーティ Launcher の UX が著しく低下（ホームへ戻る等の基本ジェスチャーが使えない）。
* 調査結果：

  * MIUI/HyperOS は**第三者 HOME 設定時にジェスチャーを落とす**仕様。
  * いくつかの“裏技”報告はあるが、**機種/ロム/バージョン依存・再現性低**。
  * 非 Root での恒常的な回避策は存在せず、**製品レベル対応は不可能**。
* 方針合意：**Xiaomi 向けは凍結**。AOSP 系では継続開発。

## 4. 技術的前提・制約（事実）

* **Android のジェスチャー実装は SystemUI＋Quickstep（Recents provider）と強く結合**しており、Quickstep は**特権（priv-app）前提**。インストール型ランチャーは完全な統合ができない。
* **Xiaomi（MIUI/HyperOS）**は、サードパーティ HOME 設定時に**システム側でジェスチャー設定を 3 ボタンへロールバック**する挙動が広範に確認できる。
* **AOSP/Pixel 系**では、サードパーティ Launcher でも**ジェスチャー自体は動作**する実績がある（ただし完全な遷移一体感は端末/OS 依存）。
* Root／カスタム ROM による回避（Magisk＋QuickSwitch 等）は**技術検証としては有効**だが、**量産・配布向けの公式解にはならない**。

## 5. 対応可否マトリクス（現時点仕様）

| 区分                   | サードパーティ Launcher + システムジェスチャー | 備考                                                  |
| -------------------- | ----------------------------- | --------------------------------------------------- |
| Xiaomi（MIUI/HyperOS） | **不可**                        | HOME を外部に切替 → システムが 3 ボタンへ強制。公式な有効化手段なし。            |
| AOSP/Pixel           | **可（原則）**                     | 動作はするが、Quickstep 非特権ゆえ遷移の完全一致は保証外。                  |
| Root + AOSP          | **可（高連携）**                    | QuickSwitch 等で Recents provider 差替えにより一体感向上（製品非対象）。 |

## 6. 既知の代替案（製品採用可否含む）

* **非 Root・オーバーレイ型ジェスチャーアプリ（例：Fluid NG）**

  * 概要：オーバーレイでスワイプを疑似実装。`WRITE_SECURE_SETTINGS` 付与で最適化。
  * 評価：**模倣動作**であって純正ジェスチャーではない。OS 更新で挙動変化・不安定化のリスク。**製品既定値には採用しない**（ユーザー任意のオプション案内に留める）。
* **Second Space 等の一時的トリック**

  * 評価：**再現性低・持続性なし**。**不採用**。
* **Root/Magisk/ROM 置換**

  * 評価：**技術検証向けのみ**。**製品不採用**。

## 7. 製品仕様（出荷時の挙動）

1. **端末/OEM 検知 → 挙動分岐**

   * `NavigationInfoResolver` で `Settings.Secure.NAVIGATION_MODE` を参照し、かつ `Xiaomi/Redmi/POCO/BlackShark` など制限 OEM をリスト管理。どちらかで 3 ボタンであると判定した場合は **3ボタン前提レイアウト**へ自動フォールバック（ヒント・導線の最適化、タップ到達距離の短縮など）。
   * AOSP 系は**ジェスチャー前提 UI**をデフォルト有効。
2. **ユーザー向け表示**

   * Xiaomi 端末でジェスチャー不可の旨を**明示（設定画面内の説明）**。
   * 希望者に限り、**オーバーレイ型ジェスチャーアプリの利用手順（自己責任）**を案内可能。
3. **設定検出**

   * HOME ロール取得の有無、およびナビモード（3ボタン/ジェスチャー）状態を**起動時に検査**し、UI を切替。
4. **UI 表示**

   * `NavigationNotice` コンポーネントを設定画面最上段に常設し、3ボタン時は OEM 名入りの警告テキストを即座に表示。AOSP 端末で 3 ボタンを選んでいる場合も一般メッセージを表示して戻る操作を案内する。

## 8. 検証計画（端末試験テーブル）

* **Xiaomi（複数機種、HyperOS 1/2／MIUI 14）**

  * 期待結果：サードパーティ HOME 設定 → **3ボタンへ強制**。設定 UI でジェスチャー選択が無効化される／戻る。
  * パス条件：上記再現＋アプリの 3ボタン前提 UI が崩れない。
* **Pixel（Android 14/15）・AOSP 機**

  * 期待結果：**ジェスチャー動作**（ホーム/戻る/最近）。
  * パス条件：主要画面のスワイプ操作が機能し、重大なフリーズや描画破綻がない。
* **回帰**

  * OS アップデートごとに**ナビゲーション操作のスモークテスト**を実施。

## 9. リスクと制限事項

* OEM 側の仕様変更（特に Xiaomi 系）により、フォールバックロジックや検知方法に変更が必要となる可能性。
* AOSP 系でも、OS メジャー更新時に**アニメーション連携の退行**が発生する可能性。
* 代替ジェスチャーアプリは**恒常解ではなく、サポート対象外**。

## 10. ドキュメント／リポジトリ関連（本件に直結する事実）

* ランチャー基盤は Compose + ViewModel 構成で整理済み。
* `MainActivity` は HOME ロール関連のガード・ナビホスト構成で統一。
* 仕様凍結方針は **Xiaomi＝凍結、AOSP＝継続** を本仕様に明記。
* `.gitignore` は APK のみトラックする例外規則を末尾に配置（ビルド生成物は非管理）。
* Debug/Release 署名の取り回しは `gradle.properties`（または環境変数）で外出し管理。

## 11. 実装アップデート（2025-11-15）

* `LauncherConfig` にナビ検知や統計関連の定数を集約し、ViewModel から参照。
* `NavigationInfo` と `NavigationInfoResolver` で OEM/モードを 1 箇所に集約し、`LauncherState` へ保持。
* `NavigationNotice` により Xiaomi 等で戻れない課題を UI 上で即時告知し、操作手がかりを提供する。
